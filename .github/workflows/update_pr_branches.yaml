name: Update PR Branches
on:
  push:
    branches:
      - master
      - krypton-daily

jobs:
  update-prs:
    name: Update PR Branches
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@0.2.0
        with:
          github-token: ${{github.token}}
          script: |
            const whitelistLabel = "auto-update";
            let [owner, repo] = context.payload.repository.full_name.split("/");

            github.pulls.list({owner, repo})
              .then(res => {
                const prs = res.data;
                for (const pr of prs) {
                  const pull_number = pr.number;
                  const prLabelNames = pr.labels.map(label => label.name);
                  if (prLabelNames.includes(whitelistLabel)) {
                    let mergeableState = pr.mergeable_state;

                    if (mergeableState == undefined) {
                      github.pulls.get({owner, repo, pull_number})
                      .then(res => {
                         mergeableState = res.data.mergeable_state;
                      })
                    }

                    if (mergeableState== "behind") {
                      console.log(`Updating PR #${pull_number}`);
                      github.pulls.updateBranch({owner, repo, pull_number});
                    } else {
                      console.log(pr);
                      console.log(`Skipping PR #${pull_number} since it is not out of date. Current PR state: '${mergeableState}'`);
                    }
                  } else {
                    // This relies on the mergeable_state value of "behind" overriding
                    // all other states. I am sure that it shows if a PR is both "behind" and "blocked",
                    // but I am not certain other states will override it.
                    console.log(`Skipping PR #${pull_number} since it does not have the '${whitelistLabel}' tag.`);
                  }
                }
              })
